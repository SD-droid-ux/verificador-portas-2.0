import streamlit as st
import pandas as pd

st.set_page_config(page_title="ðŸ” CTOs PrÃ³ximas", layout="wide")
st.title("ðŸ” AnÃ¡lise de CTOs UtilizÃ¡veis e Saturadas")

# URL do arquivo Excel no GitHub (raw)
github_url = "https://raw.githubusercontent.com/seu-usuario/verificador-portas-2.0/main/base_de_dados/base.xlsx"

@st.cache_data(ttl=600)
def carregar_dados():
    try:
        df = pd.read_excel(github_url)
        return df
    except Exception as e:
        st.error(f"Erro ao carregar dados do GitHub: {e}")
        return None

df = carregar_dados()

if df is None:
    st.stop()

# Verifica colunas obrigatÃ³rias
colunas_necessarias = {"CIDADE", "POP", "CHASSI", "PLACA", "OLT", "PORTAS", "CTO"}
if not colunas_necessarias.issubset(df.columns):
    st.error("âŒ A planilha estÃ¡ faltando colunas obrigatÃ³rias: " + ", ".join(colunas_necessarias - set(df.columns)))
    st.stop()

# Filtro por cidade
cidade = st.selectbox("Selecione a cidade:", sorted(df["CIDADE"].dropna().unique()))
df = df[df["CIDADE"] == cidade].copy()

# Limpeza
for col in ["POP", "CHASSI", "PLACA", "OLT"]:
    df[col] = df[col].astype(str).str.strip().str.upper()

df["PORTAS"] = pd.to_numeric(df["PORTAS"], errors="coerce").fillna(0).astype(int)

# Soma de portas por grupo
total_portas_por_grupo = df.groupby(["POP", "CHASSI", "PLACA", "OLT"])["PORTAS"].sum().to_dict()

# CategorizaÃ§Ã£o
def categorizar(row):
    chave = (row["POP"], row["CHASSI"], row["PLACA"], row["OLT"])
    total = total_portas_por_grupo.get(chave, 0)
    
    if total >= 128:
        return "ðŸ”´ SATURADO"
    elif row["PORTAS"] == 16 and total < 128:
        return "âœ… CTO JÃ Ã‰ SP16 MAS A PON NÃƒO ESTÃ SATURADA"
    elif row["PORTAS"] == 8 and total < 128:
        return "âœ… TROCA DE SP8 PARA SP16"
    else:
        return "ðŸ”´ SATURADO"

df["CATEGORIA"] = df.apply(categorizar, axis=1)

df_uso = df[df["CATEGORIA"].str.startswith("âœ…")].copy()
df_n_uso = df[df["CATEGORIA"].str.startswith("ðŸ”´")].copy()

# ExibiÃ§Ã£o
st.subheader("âœ… CTOs que PODEMOS usar")
st.dataframe(df_uso, use_container_width=True)

st.subheader("ðŸ”´ CTOs que NÃƒO PODEMOS usar")
if df_n_uso.empty:
    st.info("Nenhuma CTO saturada encontrada.")
else:
    st.dataframe(df_n_uso, use_container_width=True)
